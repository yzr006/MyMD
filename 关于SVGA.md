# 关于 SVGA

## 背景
客户端同学在处理 SVGA 动画的时候，发现有些看起来很小的 SVGA，实际跑在手机里时，占用内存却很大，很有迷惑性。所以希望在源头处，也就是 OMS 上传 SVGA 的时候，就进行一次检测，及时发现问题，进行优化处理，避免影响客户端性能。

## 什么是 SVGA
官网介绍：
> SVGA 是一种跨平台的开源动画格式，同时兼容 iOS / Android / Web。SVGA 使用简单，性能卓越，同时让动画开发分工明确，各自专注各自的领域，大大减少动画交互的沟通成本，提升开发效率。动画设计师专注动画设计，通过工具输出 svga 动画文件，提供给开发工程师在集成 svga player 之后直接使用。

第三方介绍：
> SVGA，是把动画用代码的方式记录了下来，打包成一个文件，然后放到各端的播放器上播出来。跟序列帧那种“保存所有动效每一帧的每个像素”相比，SVGA 文件要小很多。

另外，关于常见的几种动画格式的对比，可以参考[这篇文章](https://saysth.design/2019/06/04/svga01-0/))。这里就不展开了。

## 图片体积 & 图片占用内存
图片体积：
> 我们在电脑上看到的 png 格式或者 jpg 格式的图片，png(jpg) 只是这张图片的容器，它们都使用了相应的压缩算法，将原图每个像素点信息转换成了另一种数据格式，以达到压缩体积，减少图片文件大小的目的。

图片占用内存：
> 当我们通过代码，将图片加载进内存时，系统会先解析图片文件本身的数据格式，然后还原为位图，也就是 Bitmap 对象，Bitmap 的大小，取决于像素点的数据格式，以及分辨率。

通常来说，一个 SVGA，都是由多张 32 位的 PNG 图片打包压缩而成。所以，SVGA 加载之后所占用的内存大小，就是其内部所有 PNG 图像所占用内存的总大小。

所谓的 32 位 PNG，即：每个像素点需要用 32 bit，即 32 个二进制位进行表示，即每个像素点，占用 32 / 8 = 4 byte 的内存。

所以，一张 32 位的 PNG 图片，占用的内存大小，计算公式为：
> 像素长 * 像素宽 * 32 / 8 = 像素数量 * 4 (Byte)


## SVGA 占用内存的计算
### Node 端获取方式
SVGA Path -> ArrayBuffer -> Pako 解压 -> 根据一份 PB 协议解析出内部的 PNG -> 获取每个 PNG 的宽高 -> 计算每个 PNG 的内存大小 -> 内存总和

感兴趣的同学，可以研究下[源码](https://gitlab.com/lnts/svga-check-memory/-/blob/master/index.js)。
### 纯前端获取方式
官方提供了 SVGA Parser 工具，可以解析 SVGA 文件，获取内部所有 PNG 的宽高，计算每个 PNG 的内存大小，再计算总和即可。
#### 挖掘 SVGA 官网的计算方式
打开控制台 -> 定位到显示内存大小的 DOM 元素 -> 获取 DOM 元素 ID -> 在控制台源码中搜索 ID -> 找到相关源码 -> 复制到编辑器并格式化 -> 细品即可
